#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Run tests before push
npm run test:unit

# Run Lighthouse audit on main pages
echo "🚀 Running Lighthouse performance checks..."
npm run build --silent

# Check if build succeeded
if [ $? -ne 0 ]; then
  echo "❌ Build failed. Please fix build errors before pushing."
  exit 1
fi

# Run quick Lighthouse check
node -e "
const { exec } = require('child_process');
const chalk = require('chalk');

console.log(chalk.blue('Running quick Lighthouse audit...'));

// Just check the main page for speed
exec('npm run lighthouse:local -- --url index.html --no-open', (error, stdout, stderr) => {
  if (error) {
    console.error(chalk.red('Lighthouse audit failed. Check performance before pushing.'));
    process.exit(1);
  }
  
  // Extract scores from output
  const performanceMatch = stdout.match(/Performance: (\\d+)/);
  const accessibilityMatch = stdout.match(/Accessibility: (\\d+)/);
  
  if (performanceMatch && parseInt(performanceMatch[1]) < 70) {
    console.error(chalk.red('Performance score is too low. Please optimize before pushing.'));
    process.exit(1);
  }
  
  if (accessibilityMatch && parseInt(accessibilityMatch[1]) < 90) {
    console.error(chalk.red('Accessibility score is too low. Please fix a11y issues before pushing.'));
    process.exit(1);
  }
  
  console.log(chalk.green('✅ Lighthouse checks passed!'));
});
" || exit 1

echo "✅ All pre-push checks passed!"